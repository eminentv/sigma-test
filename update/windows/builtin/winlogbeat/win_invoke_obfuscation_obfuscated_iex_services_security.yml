alert:
- debug
description: "Detects all variations of obfuscated powershell IEX invocation code generated by Invoke-Obfuscation framework from the following code block \u2014 https://github.com/danielbohannon/Invoke-Obfuscation/blob/master/Out-ObfuscatedStringCommand.ps1#L873-L888"
filter:
- query:
    query_string:
      query: (winlog.channel:"Security" AND winlog.event_id:"4697" AND (winlog.event_data.ServiceFileName.keyword:/\$PSHome\[\s*\d{1,3}\s*\]\s*\+\s*\$PSHome\[/ OR winlog.event_data.ServiceFileName.keyword:/\$ShellId\[\s*\d{1,3}\s*\]\s*\+\s*\$ShellId\[/ OR winlog.event_data.ServiceFileName.keyword:/\$env:Public\[\s*\d{1,3}\s*\]\s*\+\s*\$env:Public\[/ OR winlog.event_data.ServiceFileName.keyword:/\$env:ComSpec\[(\s*\d{1,3}\s*,){2}/ OR winlog.event_data.ServiceFileName.keyword:/\\*mdr\*\W\s*\)\.Name/ OR winlog.event_data.ServiceFileName.keyword:/\$VerbosePreference\.ToString\(/ OR winlog.event_data.ServiceFileName.keyword:/\String\]\s*\$VerbosePreference/))
index: winlogbeat-*
name: fd0f5778-d3cb-4c9a-9695-66759d04702a-Invoke-Obfuscation-Obfuscated-IEX-Invocation
priority: 2
realert:
  minutes: 0
type: any

import: BaseHive.config
import: BaseTeams.config
import: BaseRule.config
